{% extends 'base.html' %}

{% block title %}{{ unit.name }}{% endblock title %}

{% block content %}

<h2>{{ unit.name }}</h2>
<br>
<div class="progress" style="height: 20px;">
  <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
</div>
<br>
<div id="unit-lessons" class="jumbotron">
    <div class="card-deck d-none" id="prerequisite">
        <div class="card text-center">
            <div class="card-body">
                <h5>Prerequisite Topics</h5>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    // Initializing variables
    const lessons_url = "http://127.0.0.1:8000/lessons/";
    let unit_lessons = document.getElementById("unit-lessons");
    let parent_adjacency_matrix;
    let child_adjacency_matrix;
    let traversed_topological_orders = new Set();
    let remaining_topological_orders = new Set();
    let user_skill_vector;

    $.when(
        $.get("{% url 'subjects:get_subject_dependency_matrix' 'mathematics' %}", function(data, status){
            // Retrieves parent adjacency matrix (topological order) from server
            // child adjacency matrix is the transpose of parent adjacency matrix
            parent_adjacency_matrix = data.dependencies;
            child_adjacency_matrix = parent_adjacency_matrix[0].map((col, i) => parent_adjacency_matrix.map(row => row[i]));
        })
    ).then(function(){
        $.get("{% url 'units:get_unit_data' unit.id %}", function(data, status){
            // API Get data on current unit
            for (i = 0; i < data.lessons.length; i++){
                // To each retrieved lesson object, use adjacency matrix to add attribute parent_ids (set of topological ids)
                // Add each lesson's topological order to remaining_topological_orders
                parent_ids = new Set();
                parent_adjacency_matrix[data.lessons[i].topological_order].forEach(function(value, index, array){
                    if (value == 1){
                        parent_ids.add(index)
                    }
                });
                data.lessons[i]["parent_ids"] = parent_ids;
                remaining_topological_orders.add(data.lessons[i].topological_order);
            }

            while (remaining_topological_orders.size > 0){
                // Create 'tiers' of card decks based on precedence
                let deck = document.createElement("div");
                deck.setAttribute("class", "card-deck");
                unit_lessons.appendChild(document.createElement("br"));
                unit_lessons.appendChild(document.createElement("br"));
                unit_lessons.appendChild(deck);

                nl = data.lessons.filter(function(value){
                    // filters for unit lessons that are not yet traversed and whose parents have already been traversed
                    if (traversed_topological_orders.has(value.topological_order)){
                        return false
                    }
                    for (elem of remaining_topological_orders){
                        if (value.parent_ids.has(elem)){
                            return false
                        }
                    }
                    return true
                });

                for (x of nl){
                    // Initializing card, card_body, link, and title vars
                    let card = document.createElement("div");
                    let card_body = document.createElement("div");
                    let lesson_link = document.createElement("a");
                    let card_title = document.createElement("h5");

                    // Setting attributes
                    card_title.setAttribute("class", "card-title");
                    card_title.innerHTML = x.lesson_title;
                    lesson_link.setAttribute("href", lessons_url.concat(x.slug));
                    card_body.setAttribute("class", "card-body");
                    card.setAttribute("id", x.slug);
                    card.setAttribute("data-topological-order", x.topological_order);
                    card.setAttribute("class", "card text-center");

                    // Appending children
                    lesson_link.appendChild(card_title);
                    card_body.appendChild(lesson_link);
                    card.appendChild(card_body);
                    deck.appendChild(card);

                    for (i of Array.from(x.parent_ids)){
                        // Connects to DOM elements with data-topological-attribute == topological order in parent_ids
                        // If not in graph, display "prerequisite" card and connect to it
                        if (traversed_topological_orders.has(i)){
                            parent_card_id = $(`div[data-topological-order="${i}"]`).attr('id');
                            jsPlumb.connect({source: parent_card_id,
                                             target: x.slug,
                                             endpoint:"Blank",
                                             anchor:["Top", "Bottom"],
                                             connector:["Bezier", {curviness: 20}]});
                        } else {
                            document.getElementById("prerequisite").setAttribute("class", "card-deck");
                            jsPlumb.connect({source: "prerequisite",
                                             target: x.slug,
                                             endpoint:"Blank",
                                             anchor:["Left", "Right"],
                                             connector:["Bezier", {curviness: 20}]});
                        }
                        jsPlumb.repaintEverything();
                    }
                }
                for (elem of nl){
                    // Update remaining_topological_orders and traversed_topological_orders using nl
                    remaining_topological_orders.delete(elem.topological_order);
                    traversed_topological_orders.add(elem.topological_order);
                }
            }
        });
    }).then(function(){
    {% if user.is_authenticated %}
        $.get("{% url 'userprofiles:get_subject_skills' 'mathematics' %}", function(data, status){
            const user_skill_vector = data.skill_level_list;
            let lesson_topological_orders = {{ unit.lesson_topological_orders }};
            let num_complete = 0;
            for (i of lesson_topological_orders){
                card_id = $(`div[data-topological-order="${i}"]`).attr('id');
                if (user_skill_vector[i] > 0.5){
                    num_complete += 1;
                    jsPlumb.select({target: card_id}).setPaintStyle({stroke: "rgb(2, 117, 216)"})
                } else{
                    let readiness = true;
                    let parents = [];
                    parent_adjacency_matrix[i].forEach(function(value, index, array){
                        if (value == 1){
                            parents.push(index);
                        }
                    });

                    for (j of parents){
                        let parent_id;
                        if (traversed_topological_orders.has(j)){
                            parent_id = $(`div[data-topological-order="${j}"]`).attr('id');
                        } else {
                            parent_id = "prerequisite";
                        }
                        if (user_skill_vector[j] > 0.5){
                            jsPlumb.select({source: parent_id, target: card_id}).setPaintStyle({stroke: "rgb(2, 117, 216)"});
                        } else {
                            readiness = false;
                            jsPlumb.select({source: parent_id, target: card_id}).setPaintStyle({stroke: "rgb(153, 153, 153)"});
                        }
                    }

                    if (readiness == true){
                        $(`div[data-topological-order="${i}"]`).find("a").attr("class", "text-warning");
                    } else {
                        $(`div[data-topological-order="${i}"]`).find("a").attr("class", "text-muted");
                    }
                }
            }

            if (num_complete == lesson_topological_orders.length){
                $(".progress-bar").attr("style", `width: 100%`);
                $(".progress-bar").attr("aria-valuenow", 100);
                $(".progress-bar").text("Unit Complete!");
            } else {
                percentage = num_complete * 100 / lesson_topological_orders.length
                $(".progress-bar").attr("style", `width: ${percentage}%`);
                $(".progress-bar").attr("aria-valuenow", percentage);
                $(".progress-bar").text(`${Math.round(percentage * 10) / 10}%`);
            }
        });
    {% else %}
        $(".progress-bar").attr("style", "width: 100%");
        $(".progress-bar").attr("class", "progress-bar bg-secondary");
        $(".progress-bar").attr("aria-valuenow", 100);
        $(".progress-bar").text("Log in to see your progress!");
    {% endif %}
    });

    $(window).resize(function(){
        jsPlumb.repaintEverything();
    });
});
</script>

{% endblock content %}

