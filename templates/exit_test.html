{% extends 'base.html' %}


{% block title %}{{ lesson.lesson_title}} Test{% endblock title %}

{% block content %}
<div class="jumbotron">
    <div id="questionbox">
        <p id="question-prompt" class=""></p>
    </div>
    <br>
    <div id="answerbox" class="">
        <div id="inputbox"></div>
        <br>
        <button name="submit_answer" type="submit" class="d-none">Check Answer</button>
        <br>
    </div>
    <div id="feedback" class="d-none">
        <p id="feedback-text"></p>
        <button id="next" class="btn btn-primary float-right">Next</button>
        <br>
    </div>
</div>

<hr/>

<button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#bugReportModal">
  Report a Bug
</button>

<!-- Modal -->
<div class="modal fade" id="bugReportModal" tabindex="-1" role="dialog" aria-labelledby="bugReportModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bugReportModalLabel">Question Bug Report Form</h5>
                <button id="close-report-submission" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="bug-report-form">
                    <div class="form-group">
                        <p>What was the issue with this question?</p>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="PI" name="bugChoice" class="custom-control-input">
                            <label class="custom-control-label" for="PI">There is something wrong with the question prompt</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="AI" name="bugChoice" class="custom-control-input">
                            <label class="custom-control-label" for="AI">There is something wrong with the answer(s)</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="DI" name="bugChoice" class="custom-control-input">
                            <label class="custom-control-label" for="DI">The question is not displaying correctly</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="OT" name="bugChoice" class="custom-control-input">
                            <label class="custom-control-label" for="OT">Other</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="report-message">Please describe the problem in more detail (max 2000 characters).</label>
                        <textarea class="form-control" id="report-message" rows="5"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <p id="submission-feedback"></p>
                <button id="send-bug-report" type="submit" class="btn btn-primary">Send Bug Report</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    // KaTeX function to render math elements
    renderKatex(document.body);
    function renderKatex(DOM) {
        renderMathInElement(DOM, {
        delimiters: [
                      {left: "$$", right: "$$", display: true},
                      {left: "\\(", right: "\\)", display: false},
                      {left: "\\[", right: "\\]", display: true}
                    ]
        });
    }

    // Gets cookie w/ name attribute
    const csrftoken = getCookie('csrftoken');
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== ''){
            let cookies = document.cookie.split(';');
            for (i = 0; i < cookies.length; i++){
                let cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')){
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // These HTTP methods do not require CSRF protection
    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    // Setting up ajax headers to include csrftoken
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    // storing DOM elements for manipulation
    const prompt = document.getElementById("question-prompt");
    const answerbox = document.getElementById("answerbox");
    const inputbox = document.getElementById("inputbox");
    const feedbackbox = document.getElementById("feedback");

    // Initializing variables related to questions and data
    let parent_adjacency_matrix;
    let child_adjacency_matrix;
    let user_skill_vector;
    let question_pack_data;
    let currentQ;
    let data_list = [];

    $.when(
        $.get("{% url 'subjects:get_subject_data' lesson.skill.subject.slug %}", function(data, status){
            // Retrieves parent adjacency matrix (topological order) from server
            // child adjacency matrix is the transpose of parent adjacency matrix
            parent_adjacency_matrix = data.subject_data.dependencies;
            child_adjacency_matrix = parent_adjacency_matrix[0].map((col, i) => parent_adjacency_matrix.map(row => row[i]));
            user_skill_vector = data.skill_level_list;
        }),
        $.get("{% url 'skills:skill_question_pack' lesson.skill.pk %}", function(data, status){
            // Retrieves user proficiency data; stores user skill and question data
            question_pack_data = data.questions;
        })
    ).then(function(){
        tester();
    })

    // Top level function that starts the testing process
    function tester() {
        if (question_pack_data.length > 0) {
            // sets currentQ to the next question in question_pack_data list; calls presentQuestion
            currentQ = question_pack_data.pop()
            presentQuestion();
        } else {
            // if no more questions to test, calls sendResponseData
            sendResponseData();
        }
    }

    // When called, changes DOM to present currentQ
    function presentQuestion() {
        // displays question prompt text
        prompt.innerHTML = currentQ.question_prompt;
        renderKatex(prompt);
        // displays question prompt image if present
        if (currentQ.image_url){
            let prompt_image = document.createElement("img");
            prompt_image.setAttribute("class", "img-fluid");
            prompt_image.setAttribute("src", currentQ.image_url);
            document.getElementById("questionbox").appendChild(prompt_image);
        }

        switch (currentQ.question_type){
            case "MC":
                // Multiple Choice case
                // Create mc_inputbox form element, append to inputbox as child
                let mc_inputbox = document.createElement("form");
                mc_inputbox.setAttribute("id", "mc_inputbox");
                inputbox.appendChild(mc_inputbox);

                // For each answer choice, create choicebox, append radio input and label to choicebox
                // Append choicebox to mc_inputbox
                currentQ.answers.forEach(function(value, index, array){
                    let choicebox = document.createElement("div");
                    choicebox.setAttribute("class", "custom-control custom-radio");

                    let input = document.createElement("input");
                    input.setAttribute("type", "radio");
                    input.setAttribute("id", index);
                    input.setAttribute("name", "answer_choice");
                    input.setAttribute("value", value.answer_correctness);
                    input.setAttribute("class", "custom-control-input");
                    choicebox.appendChild(input);

                    let label = document.createElement("label");
                    label.setAttribute("class", "custom-control-label");
                    label.setAttribute("for", index);
                    label.innerHTML = value.answer_text;
                    choicebox.appendChild(label);

                    mc_inputbox.appendChild(choicebox);
                });

                renderKatex(mc_inputbox);
                break;
            case "IC":
                // Image Choice case
                // Create ic_inputbox form element, append to inputbox as child
                let ic_inputbox = document.createElement("form");
                ic_inputbox.setAttribute("id", "ic_inputbox");
                inputbox.appendChild(ic_inputbox);

                // For each answer choice, create choicebox, append radio input and label to choicebox
                // Append choicebox to ic_inputbox
                currentQ.answers.forEach(function(value, index, array){
                    let choicebox = document.createElement("div");
                    choicebox.setAttribute("class", "custom-control custom-radio custom-control-inline");

                    let input = document.createElement("input");
                    input.setAttribute("type", "radio");
                    input.setAttribute("id", index);
                    input.setAttribute("name", "answer_choice");
                    input.setAttribute("value", value.answer_correctness);
                    input.setAttribute("class", "custom-control-input");
                    choicebox.appendChild(input);

                    let label = document.createElement("label");
                    label.setAttribute("class", "custom-control-label");
                    label.setAttribute("for", index);

                    let answer_image = document.createElement("img");
                    answer_image.setAttribute("style", "max-width:200px;max-height:200px");
                    answer_image.setAttribute("src", value.image_url);
                    label.appendChild(answer_image);

                    choicebox.appendChild(label);
                    ic_inputbox.appendChild(choicebox);
                });

                renderKatex(ic_inputbox);
                break;
            case "NI":
                // Numerical Input case
                // Create guppy isntance with id "guppybox", append to inputbox
                let guppybox = document.createElement("div");
                guppybox.setAttribute("id", "guppybox");
                inputbox.appendChild(guppybox);
                new Guppy("guppybox");
                break;
            default:
                $("#inputbox").text("No such question type found.");
        }
        // Displays "submit answer" button
        $("button[name='submit_answer']").attr("class", "btn btn-primary float-right");
    }

    // When called with list of dicts, sends new user skill level as AJAX post response
    function sendResponseData(){
        let parent_topological_orders = new Set();
        let child_topological_orders = new Set();
        let queued_parent_topological_orders = [];
        let queued_child_topological_orders = [];
        let user_skill_level = user_skill_vector[{{ lesson.skill.topological_order }}]
        let delta = 0;
        let depreciating = [];
        let appreciating = [{{ lesson.skill.topological_order }}];

        parent_adjacency_matrix[{{ lesson.skill.topological_order }}].forEach(function(value, index, array){
            if (value == 1){
                queued_parent_topological_orders.push(index)
            }
        });
        while (queued_parent_topological_orders.length > 0){
            let current = queued_parent_topological_orders.pop();
            parent_topological_orders.add(current);
            parent_adjacency_matrix[current].forEach(function(value, index, array){
                if (value == 1){
                    queued_parent_topological_orders.push(index)
                }
            });
        }

        child_adjacency_matrix[{{ lesson.skill.topological_order }}].forEach(function(value, index, array){
            if (value == 1){
                queued_child_topological_orders.push(index)
            }
        });
        while (queued_child_topological_orders.length > 0){
            let current = queued_child_topological_orders.pop();
            child_topological_orders.add(current);
            child_adjacency_matrix[current].forEach(function(value, index, array){
                if (value == 1){
                    queued_child_topological_orders.push(index)
                }
            });
        }

        for (i of data_list){
            delta += i.a_correctness;
        }
        delta /= data_list.length
        user_skill_level += delta - 0.5;
        if (user_skill_level < 0){
            user_skill_level = 0;
        } else if (user_skill_level > 1) {
            user_skill_level = 1;
        } else {
            // pass
        }

        Array.from(parent_topological_orders).forEach(function(value, index, array){
            if (user_skill_vector[value] < user_skill_level){
                appreciating.push(value);
            }
        });
        Array.from(child_topological_orders).forEach(function(value, index, array){
            if (user_skill_vector[value] > user_skill_level){
                depreciating.push(value);
            }
        });

        to_be_updated = [{"topological_orders": appreciating, "skill_level": user_skill_level}, {"topological_orders": depreciating, "skill_level": user_skill_level}];
        response = {"update_via": "topological_order", "to_be_updated": to_be_updated}
        $.ajax({
            type: "POST",
            // To create new url api for this bulk send in backend
            url: "{% url 'userprofiles:subject_posttest_update' lesson.skill.subject.slug %}",
            data: JSON.stringify(response),
            dataType: "json",
            contentType: "application/json",
            error: function(data){
                prompt.innerHTML = "Oops! It seems like something went wrong when sending your data to the server. Click <a href=\"{% url 'home' %}\">here</a> to go back to the homepage."
            },
            success: function(data){
                prompt.innerHTML = "Congrats! You have completed the lesson. Click <a href=\"{% url 'home' %}\">here</a> to go back to the homepage.";
            }
        });
    }

    // On "submit_answer" button click
    $("button[name='submit_answer']").on('click', function(e){
        e.preventDefault();

        // Hides "submit answer" button
        $("button[name='submit_answer']").attr("class", "btn btn-primary d-none");

        // Initializes variables to be appended to response
        let q_id = currentQ.id;
        let q_type = currentQ.question_type;
        let a_correctness;
        let feedback_text = "";

        // Different ways of retrieving "a_correctness" dependent on question type
        switch(q_type) {
            case "MC":
                a_correctness = parseFloat($('input[name="answer_choice"]:checked', '#mc_inputbox').val());
                feedback_text = currentQ.answers[$('input[name="answer_choice"]:checked', '#mc_inputbox').attr('id')].answer_explanation
                break;
            case "IC":
                a_correctness = parseFloat($('input[name="answer_choice"]:checked', '#ic_inputbox').val());
                feedback_text = currentQ.answers[$('input[name="answer_choice"]:checked', '#ic_inputbox').attr('id')].answer_explanation
                break;
            case "NI":
                let attempt = Guppy("guppybox").asciimath();
                symbols_used = Guppy("guppybox").symbols_used()
                try {
                    const parsed_attempt = MathExpression.fromText(attempt);
                    let matched = currentQ.answers.find(checkAnswer);
                    function checkAnswer(value, index, array) {
                        return MathExpression.fromText(attempt).equals(MathExpression.fromText(value.answer_text));
                    }
                    if (symbols_used.length > 0){
                        a_correctness = 0;
                        feedback_text = "The answer should be a number!";
                    } else if (typeof matched === "undefined") {
                        a_correctness = 0;
                    } else {
                        a_correctness = parseFloat(matched.answer_correctness);
                        feedback_text = matched.answer_explanation;
                    }
                }
                catch(err){
                    a_correctness = 0;
                    feedback_text = "You have entered an invalid input!"
                }
                break;
        }

        if (a_correctness == 1){
            $("#feedback-text").text("Correct!");
        } else if (a_correctness > 0.5) {
            correct_answer = currentQ.answers.find(function(value, index, array){
                return value.answer_correctness == 1
            });
            $("#feedback-text").text("Close! " + feedback_text + " The correct answer is " + correct_answer.answer_text + ".");
        } else {
            correct_answer = currentQ.answers.find(function(value, index, array){
                return value.answer_correctness == 1
            });
            $("#feedback-text").text("Incorrect. " + feedback_text + " The correct answer is " + correct_answer.answer_text + " .");
        }
        renderKatex(feedbackbox);
        feedbackbox.setAttribute("class", "");

        // Aggregates data, appends everything to data_list
        let data = {};
        data.q_id = q_id;
        data.q_type = q_type;
        data.a_correctness = a_correctness;
        data_list.push(data);
    });

    // On clicking "next" button, kills DOM nodes,calls tester()
    $("#next").on('click', function(e){
        e.preventDefault();
        // to kill all children in feedbackbox
        feedbackbox.setAttribute("class", "d-none");
        // Removing children from questionbox and inputbox DOM
        if (currentQ.image_url){
            document.getElementById("questionbox").removeChild(prompt_image);
        }
        while (prompt.firstChild) {
            prompt.removeChild(prompt.firstChild);
        }
        while (inputbox.firstChild) {
            inputbox.removeChild(inputbox.firstChild);
        }
        tester();
    });

    // On clicking 'send-bug-report', modal form
    $(document).on('click', '#send-bug-report', function(e){
        e.preventDefault();
        if ($('input[name="bugChoice"]:checked').length == 0) {
            $("#submission-feedback").text("Please select the issue with the question.");
        } else if ($("#report-message").val().length > 2000) {
            $("#submission-feedback").text("Your message has exceeded 2000 characters.");
        } else {
            let reason = $('input[name="bugChoice"]:checked', '#bug-report-form').attr('id');
            let question_fk = currentQ.id;
            let report_message = $("#report-message").val();
            let bug_report_JSON = {"question": question_fk, "reason": reason, "report_message": report_message};
            $.ajax({
                type: "POST",
                // To create new url api for this bulk send in backend
                url: "{% url 'question-report' %}",
                data: JSON.stringify(bug_report_JSON),
                dataType: "json",
                contentType: "application/json",
                error: function(data){
                    $("#submission-feedback").text("Oops! It seems like something went wrong when sending your data to the server. Please try again later.")
                },
                success: function(data){
                    $(".modal-body").hide();
                    $("#send-bug-report").hide();
                    $("#submission-feedback").text("Thank you for your feedback! Your response has been received.")
                }
            });
        }
    });

    // on closing bug report modal, reset all fields
    $(document).on('click', '#close-report-submission', function(e){
        $('input[name="bugChoice"]').prop('checked', false);
        $("#report-message").val("");
        $(".modal-body").show();
        $("send-bug-report").show();
    });
});
</script>
{% endblock content %}